# .github/workflows/terraform-destroy.yml
name: 'Terraform Destroy Infrastructure'

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment to destroy'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prod
      confirmation:
        description: 'Type "DESTROY" to confirm you want to destroy infrastructure'
        required: true
        type: string
      reason:
        description: 'Reason for destroying infrastructure'
        required: true
        type: string

permissions:
  id-token: write       # Required for OIDC
  contents: read        # Required for checkout
  issues: write         # For posting destruction summary

env:
  TF_WORKING_DIR: './terraform'

jobs:
  # Validation job to ensure proper inputs
  validate-inputs:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.validate.outputs.environment }}
      proceed: ${{ steps.validate.outputs.proceed }}
    steps:
    - name: Validate Inputs
      id: validate
      run: |
        # Check if confirmation matches
        if [ "${{ github.event.inputs.confirmation }}" != "DESTROY" ]; then
          echo "‚ùå Confirmation must be exactly 'DESTROY'"
          exit 1
        fi

        # Validate environment
        if [[ ! "${{ github.event.inputs.environment }}" =~ ^(dev|prod)$ ]]; then
          echo "‚ùå Environment must be 'dev' or 'prod'"
          exit 1
        fi

        # Check reason is provided
        if [ -z "${{ github.event.inputs.reason }}" ]; then
          echo "‚ùå Reason for destruction is required"
          exit 1
        fi

        echo "‚úÖ All inputs validated"
        echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
        echo "proceed=true" >> $GITHUB_OUTPUT

    - name: Display Destruction Plan
      run: |
        echo "üö® INFRASTRUCTURE DESTRUCTION REQUEST"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Requester: ${{ github.actor }}"
        echo "Reason: ${{ github.event.inputs.reason }}"
        echo "Timestamp: $(date)"

        if [ "${{ github.event.inputs.environment }}" = "prod" ]; then
          echo "‚ö†Ô∏è  PRODUCTION ENVIRONMENT - MANUAL APPROVAL REQUIRED"
        fi

  # Plan destruction to show what will be destroyed
  plan-destroy:
    needs: validate-inputs
    runs-on: ubuntu-latest
    if: needs.validate-inputs.outputs.proceed == 'true'
    outputs:
      has-resources: ${{ steps.plan.outputs.has-resources }}
    steps:
    - name: Checkout
      uses: actions/checkout@v5

    - name: Setup Terraform and Init
      uses: ./.github/actions/terraform-setup-init
      with:
        azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
        azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        working-directory: ${{ env.TF_WORKING_DIR }}
        environment: ${{ github.event.inputs.environment }}
        storage-account-suffix: ${{ vars.RANDOM_SUFFIX }}

    - name: Plan Destruction
      id: plan
      run: |
        echo "Planning destruction for ${{ github.event.inputs.environment }} environment..."

        # Create destroy plan
        terraform plan -destroy \
          -var-file="environments/${{ github.event.inputs.environment }}/terraform.tfvars" \
          -out=destroy-plan.tfout

        # Show the destroy plan
        echo "üìã Resources to be destroyed:"
        terraform show -no-color destroy-plan.tfout | tee destroy-plan-output.txt

        # Check if there are actually resources to destroy
        if grep -q "No changes" destroy-plan-output.txt; then
          echo "‚ÑπÔ∏è  No resources found to destroy"
          echo "has-resources=false" >> $GITHUB_OUTPUT
        else
          echo "‚ö†Ô∏è  Resources found that will be destroyed"
          echo "has-resources=true" >> $GITHUB_OUTPUT
        fi
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Save Destroy Plan as Artifact
      if: steps.plan.outputs.has-resources == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: destroy-plan-${{ github.event.inputs.environment }}
        path: |
          ${{ env.TF_WORKING_DIR }}/destroy-plan.tfout
          ${{ env.TF_WORKING_DIR }}/destroy-plan-output.txt
        retention-days: 1

  # Development environment destruction (auto-approved)
  destroy-dev:
    needs: [validate-inputs, plan-destroy]
    runs-on: ubuntu-latest
    if: |
      needs.validate-inputs.outputs.environment == 'dev' &&
      needs.plan-destroy.outputs.has-resources == 'true'
    environment: development
    steps:
    - name: Checkout
      uses: actions/checkout@v5

    - name: Download Destroy Plan
      uses: actions/download-artifact@v4
      with:
        name: destroy-plan-${{ github.event.inputs.environment }}
        path: ${{ env.TF_WORKING_DIR }}/

    - name: Setup Terraform and Init
      uses: ./.github/actions/terraform-setup-init
      with:
        azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
        azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        working-directory: ${{ env.TF_WORKING_DIR }}
        environment: ${{ github.event.inputs.environment }}
        storage-account-suffix: ${{ vars.RANDOM_SUFFIX }}

    - name: Execute Destruction
      run: |
        echo "üö® Starting DEVELOPMENT infrastructure destruction"
        echo "Requester: ${{ github.actor }}"
        echo "Reason: ${{ github.event.inputs.reason }}"

        # Apply the destroy plan
        terraform apply destroy-plan.tfout

        echo "‚úÖ Development infrastructure destroyed successfully"
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Post-destruction validation
      run: |
        echo "üîç Verifying destruction..."

        # Try to plan again to ensure everything is destroyed
        terraform plan \
          -var-file="environments/${{ github.event.inputs.environment }}/terraform.tfvars" \
          -detailed-exitcode

        if [ $? -eq 0 ]; then
          echo "‚úÖ Destruction verified - no resources remain"
        else
          echo "‚ö†Ô∏è  Some resources may still exist - check manually"
        fi
      working-directory: ${{ env.TF_WORKING_DIR }}

  # Production environment destruction (requires manual approval)
  destroy-prod:
    needs: [validate-inputs, plan-destroy]
    runs-on: ubuntu-latest
    if: |
      needs.validate-inputs.outputs.environment == 'prod' &&
      needs.plan-destroy.outputs.has-resources == 'true'
    environment: production
    steps:
    - name: Checkout
      uses: actions/checkout@v5

    - name: Pre-destruction Warning
      run: |
        echo "üö®üö®üö® PRODUCTION INFRASTRUCTURE DESTRUCTION üö®üö®üö®"
        echo ""
        echo "‚ö†Ô∏è  WARNING: This will destroy ALL PRODUCTION resources!"
        echo "Environment: PRODUCTION"
        echo "Requester: ${{ github.actor }}"
        echo "Approver: ${{ github.triggering_actor }}"
        echo "Reason: ${{ github.event.inputs.reason }}"
        echo "Timestamp: $(date)"
        echo ""
        echo "üîç Please review the destroy plan carefully before proceeding."

    - name: Download Destroy Plan
      uses: actions/download-artifact@v4
      with:
        name: destroy-plan-${{ github.event.inputs.environment }}
        path: ${{ env.TF_WORKING_DIR }}/

    - name: Setup Terraform and Init
      uses: ./.github/actions/terraform-setup-init
      with:
        azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
        azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        working-directory: ${{ env.TF_WORKING_DIR }}
        environment: ${{ github.event.inputs.environment }}
        storage-account-suffix: ${{ vars.RANDOM_SUFFIX }}

    - name: Final Confirmation Check
      run: |
        echo "üî¥ FINAL SAFETY CHECK"
        echo "This is your last chance to abort the production destruction."
        echo "The following resources will be PERMANENTLY DELETED:"
        echo ""
        cat destroy-plan-output.txt
        echo ""
        echo "Continuing with destruction in 10 seconds..."
        sleep 10
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Execute Production Destruction
      run: |
        echo "üö® Starting PRODUCTION infrastructure destruction"
        echo "Requester: ${{ github.actor }}"
        echo "Approver: ${{ github.triggering_actor }}"
        echo "Reason: ${{ github.event.inputs.reason }}"

        # Apply the destroy plan
        terraform apply destroy-plan.tfout

        echo "üí• Production infrastructure destroyed"
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Post-destruction validation
      run: |
        echo "üîç Verifying production destruction..."

        # Try to plan again to ensure everything is destroyed
        terraform plan \
          -var-file="environments/${{ github.event.inputs.environment }}/terraform.tfvars" \
          -detailed-exitcode

        if [ $? -eq 0 ]; then
          echo "‚úÖ Production destruction verified - no resources remain"
        else
          echo "‚ö†Ô∏è  Some resources may still exist - manual cleanup required"
        fi
      working-directory: ${{ env.TF_WORKING_DIR }}